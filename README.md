### 使用的库
lombok 提供基础方法

h2database 模拟数据库

jpa orm框架

### 短链接系统
**功能**

长链接 转 短链接

访问的时候可以通过301，302做重定向

**非功能**

一、QPS，每秒查询

QPS：Queries Per Second意思是“每秒查询率”，是一台服务器每秒能够相应的查询次数，是对一个特定的查询服务器在规定时间内所处理流量多少的衡量标准。

互联网中，作为域名系统服务器的机器的性能经常用每秒查询率来衡量。
二、TPS，每秒事务

TPS：是TransactionsPerSecond的缩写，也就是事务数/秒。它是软件测试结果的测量单位。一个事务是指一个客户机向服务器发送请求然后服务器做出反应的过程。客户机在发送请求时开始计时，收到服务器响应后结束计时，以此来计算使用的时间和完成的事务个数。

QPS vs TPS：QPS基本类似于TPS，但是不同的是，对于一个页面的一次访问，形成一个TPS；但一次页面请求，可能产生多次对服务器的请求，服务器对这些请求，就可计入“QPS”之中。如，访问一个页面会请求服务器2次，一次访问，产生一个“T”，产生2个“Q”。
三、RT，响应时间

响应时间：执行一个请求从开始到最后收到响应数据所花费的总体时间,即从客户端发起请求到收到服务器响应结果的时间。

响应时间RT(Response-time)，是一个系统最重要的指标之一，它的数值大小直接反应了系统的快慢。
四、并发数

并发数是指系统同时能处理的请求数量，这个也是反应了系统的负载能力。
五、吞吐量

系统的吞吐量（承压能力）与request对CPU的消耗、外部接口、IO等等紧密关联。单个request 对CPU消耗越高，外部系统接口、IO速度越慢，系统吞吐能力越低，反之越高。

系统吞吐量几个重要参数：QPS（TPS）、并发数、响应时间。

    QPS（TPS）：（Query Per Second）每秒钟request/事务 数量
    并发数： 系统同时处理的request/事务数
    响应时间：  一般取平均响应时间

理解了上面三个要素的意义之后，就能推算出它们之间的关系：

    QPS（TPS）= 并发数/平均响应时间
    并发数 = QPS*平均响应时间

六、实际举例

我们通过一个实例来把上面几个概念串起来理解。按二八定律来看，如果每天 80% 的访问集中在 20% 的时间里，这 20% 时间就叫做峰值时间。

    公式：( 总PV数 * 80% ) / ( 每天秒数 * 20% ) = 峰值时间每秒请求数(QPS) 
    机器：峰值时间每秒QPS / 单台机器的QPS = 需要的机器

1、每天300w PV 的在单台机器上，这台机器需要多少QPS？
( 3000000 * 0.8 ) / (86400 * 0.2 ) = 139 (QPS)

2、如果一台机器的QPS是58，需要几台机器来支持？
139 / 58 = 3
七、最佳线程数、QPS、RT

1、单线程QPS公式：QPS=1000ms/RT

对同一个系统而言，支持的线程数越多，QPS越高。假设一个RT是80ms,则可以很容易的计算出QPS,QPS = 1000/80 = 12.5
多线程场景，如果把服务端的线程数提升到2，那么整个系统的QPS则为 2*（1000/80） = 25, 可见QPS随着线程的增加而线性增长，那QPS上不去就加线程呗，听起来很有道理，公司也说的通，但是往往现实并非如此。

### 服务设计

**函数调用**

**rpc接口**

shotKey encode (longUrl)

longUrl decode (shortUrl)

**http接口**

POST/shorten

入参：longUrl

出参： shortUrl

GET/(shortKey)

返回：

正常状态码 302，location：longURL

异常 ： 降级页面，短链接不存在

**算法设计**

md5 ： 实现简单 数据越多就越慢

雪花算法 ： 长度比较长，时钟回拨不好解决

常用于 URL 文件命名 防止猜测

id + base62 ：依赖自增id

### 储存设计

方案1：

mysql

字段 id int 主键 long_url varchar creation_time timestamp expire_time timestamp

uniq ： long_url

index : expire_time

方案 2：
redis

shortKey -> longUrl

longUrl -> shortKey


### 系统设计问题

功能需求

非功能

qps

1k - 2k mysql/pg 关系型数据库

10k - 50k hbase/cassadra

100k redis/memcached

更高 分布式方案

qps峰值更重要


/shorten 接口 -> 将短链接转化为一个长链接

/shortKey 重定向 短链接转为长链接

clearjob 自动清理


//TODO

//引入缓存

在decode处引用本地缓存

### 短链接系统优化